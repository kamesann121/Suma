<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>新しいタブ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #f0f0f0; font-family: "Helvetica", sans-serif; }
        #monitor { 
            position: fixed; top: 10px; left: 10px; width: 85%; max-height: 20vh; 
            background: rgba(255,255,255,0.95); color: #444; padding: 10px; font-size: 11px; 
            overflow-y: auto; z-index: 100; border: 1px solid #ddd; pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #ui-grid { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            display: flex; flex-wrap: wrap; justify-content: center; 
            gap: 6px; z-index: 100; padding: 15px; box-sizing: border-box;
            background: rgba(240,240,240,0.8); border-top: 1px solid #ccc;
        }
        button { 
            padding: 10px 14px; background: #fff; color: #333; border: 1px solid #bbb; 
            border-radius: 4px; font-size: 11px; min-width: 80px; cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        button:active { background: #e0e0e0; transform: translateY(1px); }
    </style>
</head>
<body>
    <div id="monitor">Status: System Online - Scanning Local Files...</div>
    <div id="ui-grid"></div>

    <script>
        const logEl = document.getElementById('monitor');
        const btnContainer = document.getElementById('ui-grid');
        function report(msg) { logEl.innerHTML += `<div>> ${msg}</div>`; logEl.scrollTop = logEl.scrollHeight; }

        window.onload = function() {
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0xeeeeee);
            
            const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.3, 3.5); 
            camera.lookAt(0, 1, 0);

            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // 環境光
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbbb, 1.5);
            scene.add(light);
            scene.add(new THREE.GridHelper(10, 10, 0xcccccc, 0xeeeeee));

            const loader = new THREE.GLTFLoader();
            let mixer;

            // ルート階層にある m.glb を読み込み
            report("Loading Component [M]...");
            loader.load('./m.glb', (gltf) => {
                const model = gltf.scene;
                scene.add(model);
                report("Component [M] Loaded.");

                // ルート階層にある a.glb を読み込み
                report("Loading Stream [A]...");
                loader.load('./a.glb', (animGltf) => {
                    mixer = new THREE.AnimationMixer(model);
                    
                    if (animGltf.animations && animGltf.animations.length > 0) {
                        report(`${animGltf.animations.length} Animation sequences found.`);

                        animGltf.animations.forEach((clip, index) => {
                            // 腕が伸びるのを防ぐための補正：位置（Position）データをフィルタリング
                            clip.tracks = clip.tracks.filter(track => !track.name.endsWith('.position'));

                            const btn = document.createElement('button');
                            const label = clip.name || `Sequence ${index}`;
                            btn.innerText = label;
                            
                            btn.onclick = () => {
                                mixer.stopAllAction();
                                const action = mixer.clipAction(clip);
                                action.reset().setDuration(clip.duration).fadeIn(0.2).play();
                                report(`Executing: ${label}`);
                            };
                            
                            btnContainer.appendChild(btn);
                        });

                        // 最初の動作を開始
                        mixer.clipAction(animGltf.animations[0]).play();
                    }
                }, undefined, (e) => report("Error: [A] sequence not found at root."));

            }, undefined, (e) => report("Error: [M] component not found at root."));

            const clock = new THREE.Clock();
            function animate() {
                requestAnimationFrame(animate);
                if (mixer) mixer.update(clock.getDelta());
                renderer.render(scene, camera);
            }
            animate();

            window.onresize = () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            };
        };
    </script>
</body>
</html>
