<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>新しいタブ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #e0e0e0; font-family: sans-serif; }
        #ui-sidebar { 
            position: fixed; top: 0; left: 0; width: 160px; height: 100vh; 
            background: rgba(255,255,255,0.9); border-right: 1px solid #ccc;
            display: flex; flex-direction: column; gap: 4px; padding: 10px;
            overflow-y: auto; z-index: 100; box-sizing: border-box;
        }
        #ui-sidebar button { 
            width: 100%; padding: 8px; background: #fff; border: 1px solid #999; 
            border-radius: 4px; font-size: 10px; cursor: pointer; text-align: left;
        }
        #monitor { position: fixed; top: 10px; left: 170px; font-size: 11px; color: #444; }
        #guide {
            position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: #fff;
            padding: 10px; font-size: 12px; border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="ui-sidebar"><div style="font-weight:bold;margin-bottom:5px;">Motions</div></div>
    <div id="monitor">Ready.</div>
    <div id="guide">E: Forward | S: Back | Q: Left | C: Right | Space: Jump</div>

    <script>
        const btnContainer = document.getElementById('ui-sidebar');
        function report(msg) { document.getElementById('monitor').innerText = "> " + msg; }

        let scene, camera, renderer, clock, mixer, model;
        let moveState = { q: false, e: false, c: false, s: false };
        let velocityY = 0;
        let isJumping = false;

        window.onload = function() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xdddddd);
            
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 3, 6); // 少し高めのTPS視点
            camera.lookAt(0, 1, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.HemisphereLight(0xffffff, 0x888888, 1.5));
            scene.add(new THREE.GridHelper(100, 100, 0x999999, 0xcccccc));

            const loader = new THREE.GLTFLoader();

            loader.load('./m.glb', (gltf) => {
                model = gltf.scene;
                // ★向き修正: 前後逆ならここで180度(Math.PI)回転させる
                model.rotation.y = Math.PI; 
                scene.add(model);
                mixer = new THREE.AnimationMixer(model);
                report("Model M Loaded & Rotated.");

                ['./a.glb', './b.glb'].forEach(url => {
                    loader.load(url, (animGltf) => {
                        animGltf.animations.forEach((clip, i) => {
                            clip.tracks = clip.tracks.filter(t => !t.name.endsWith('.position'));
                            const btn = document.createElement('button');
                            btn.innerText = `${url.replace('./', '')}: ${clip.name || i}`;
                            btn.onclick = () => {
                                mixer.stopAllAction();
                                mixer.clipAction(clip).reset().fadeIn(0.2).play();
                                report("Play: " + clip.name);
                            };
                            btnContainer.appendChild(btn);
                        });
                    });
                });
            });

            window.onkeydown = (e) => {
                const k = e.key.toLowerCase();
                if (k === 'e') moveState.e = true;
                if (k === 's') moveState.s = true;
                if (k === 'q') moveState.q = true;
                if (k === 'c') moveState.c = true;
                if (k === ' ' && !isJumping) {
                    isJumping = true;
                    velocityY = 0.15;
                }
            };
            window.onkeyup = (e) => {
                const k = e.key.toLowerCase();
                if (k === 'e') moveState.e = false;
                if (k === 's') moveState.s = false;
                if (k === 'q') moveState.q = false;
                if (k === 'c') moveState.c = false;
            };

            clock = new THREE.Clock();
            function animate() {
                requestAnimationFrame(animate);
                const delta = clock.getDelta();
                if (mixer) mixer.update(delta);

                if (model) {
                    const speed = 0.08;
                    // 平行移動（translateX / translateZ）
                    // model.rotation.y = Math.PI なので、移動方向もそれに準じます
                    if (moveState.e) model.translateZ(speed);  // 前（モデルの向きに対して）
                    if (moveState.s) model.translateZ(-speed); // 後
                    if (moveState.q) model.translateX(speed);  // 左（モデルの右側へスライド）
                    if (moveState.c) model.translateX(-speed); // 右（モデルの左側へスライド）

                    if (isJumping) {
                        model.position.y += velocityY;
                        velocityY -= 0.008;
                        if (model.position.y <= 0) { model.position.y = 0; isJumping = false; }
                    }
                    
                    // カメラ固定追従（キャラの後ろをキープ）
                    camera.position.x = model.position.x;
                    camera.position.z = model.position.z + 6;
                    camera.lookAt(model.position.x, model.position.y + 1, model.position.z);
                }
                renderer.render(scene, camera);
            }
            animate();
        };
    </script>
</body>
</html>
