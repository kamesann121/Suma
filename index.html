<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>新しいタブ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        #debug { position: absolute; top: 10px; left: 10px; color: #0f0; background: rgba(0,0,0,0.7); padding: 10px; z-index: 20; font-family: monospace; }
    </style>
</head>
<body>
    <div id="debug">Loading...</div>
    <script type="importmap">
    {
        "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/examples/jsm/": "https://unpkg.com/three@0.160.0/examples/jsm/" }
    }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';
        
        const debugElement = document.getElementById('debug');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff, 2));

        let mixer, actions = {}, currentAction;
        const loader = new GLTFLoader();

        // 1. 体となる night.glb を読み込む
        loader.load('./night.glb', (gltf) => {
            const model = gltf.scene;
            scene.add(model);
            mixer = new THREE.AnimationMixer(model);

            // 元から入っているモーションを walk にする
            if (gltf.animations.length > 0) {
                actions['walk'] = mixer.clipAction(gltf.animations[0]);
            }

            // 2. idle.glb からモーションだけを借りてくる
            loader.load('./idle.glb', (idleGltf) => {
                if (idleGltf.animations.length > 0) {
                    const idleClip = idleGltf.animations[0];
                    actions['idle'] = mixer.clipAction(idleClip);
                    
                    currentAction = actions['idle'];
                    currentAction.play();
                    debugElement.innerHTML = "Ready: Idle & Walk loaded";
                }
            });
        });

        // アニメーション切り替え関数
        function fadeTo(name) {
            const next = actions[name];
            if (!next || currentAction === next) return;
            next.reset().fadeIn(0.2).play();
            if (currentAction) currentAction.fadeOut(0.2);
            currentAction = next;
        }

        const keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            if (mixer) mixer.update(clock.getDelta());

            const isMoving = keys['KeyE'] || keys['KeyS'] || keys['KeyQ'] || keys['KeyC'];
            // 2つのアクションが揃っていれば切り替え
            if (actions['idle'] && actions['walk']) {
                fadeTo(isMoving ? 'walk' : 'idle');
            }

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
